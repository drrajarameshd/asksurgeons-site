{%- comment -%}
Head for doctor-authored blog posts (refined, no new fields added)
{%- endcomment -%}

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">

<title>{{ page.title | escape }}</title>
<link rel="canonical" href="{{ page.url | absolute_url }}">

<meta name="description" content="{{ page.excerpt | strip_html | strip_newlines | truncate:160 | escape }}">
<meta name="theme-color" content="#007BBF">

<link rel="icon" href="{{ '/assets/images/site-images/logo.webp' | relative_url }}" type="image/webp">
<link rel="apple-touch-icon" href="{{ '/assets/images/site-images/logo.webp' | relative_url }}">

<meta property="og:type" content="article">
<meta property="og:site_name" content="{{ site.title | escape }}">
<meta property="og:title" content="{{ page.title | escape }}">
<meta property="og:description" content="{{ page.excerpt | strip_html | strip_newlines | truncate:300 | escape }}">
<meta property="og:url" content="{{ page.url | absolute_url }}">
<meta property="og:image" content="{{ page.image | absolute_url }}">
<meta property="article:published_time" content="{{ page.date | date_to_xmlschema }}">
{%- if page.last_modified_at -%}
<meta property="article:modified_time" content="{{ page.last_modified_at | date_to_xmlschema }}">
{%- endif -%}
{%- if page.tags -%}
  {%- for t in page.tags -%}
<meta property="article:tag" content="{{ t | escape }}">
  {%- endfor -%}
{%- endif -%}

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ page.title | escape }}">
<meta name="twitter:description" content="{{ page.excerpt | strip_html | strip_newlines | truncate:200 | escape }}">
<meta name="twitter:image" content="{{ page.image | absolute_url }}">
{%- if site.twitter_username -%}
<meta name="twitter:site" content="@{{ site.twitter_username | replace: '@', '' }}">
{%- endif -%}

{%- assign doctor = site.data.doctors | where: "id", page.author-id | first -%}

<script>
  console.log("Page Id:", "{{ page.id | escape }}");
  console.log("Doctor Name:", "{{ doctor.name | escape }}");
  console.log("Doctor ID:", "{{ doctor.id | escape }}");
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": {{ page.title | jsonify }},
  "description": {{ page.excerpt | strip_html | strip_newlines | truncate:300 | jsonify }},
  "url": {{ page.url | absolute_url | jsonify }},
  "datePublished": {{ page.date | date_to_xmlschema | jsonify }}{%- if page.last_modified_at -%},
  "dateModified": {{ page.last_modified_at | date_to_xmlschema | jsonify }}{%- endif -%},
  "image": {
    "@type": "ImageObject",
    "url": {{ page.image | absolute_url | jsonify }}
  },
  "author": {
    "@type": "Person",
    "@id": {{ (site.url | append: "/doctors#" | append: doctor.id) | jsonify }},
    "name": {{ doctor.name | jsonify }},
    "jobTitle": {{ doctor.speciality | jsonify }},
    "medicalSpecialty": {{ doctor.speciality | jsonify }}{%- comment -%}
    Now append optional author properties safely (no stray/trailing commas)
    {%- endcomment -%}
    {%- capture author_props %}{% endcapture -%}

    {%- if doctor.gender -%}
      {%- capture author_props -%}{{ author_props }}{% if author_props != "" %}, {% endif %}"gender": {{ doctor.gender | jsonify }}{% endcapture -%}
    {%- endif -%}

    {%- comment -%} affiliation is site title (keeps original behaviour ) {%- endcomment -%}
    {%- capture author_props -%}{{ author_props }}{% if author_props != "" %}, {% endif %}"affiliation": {"@type":"MedicalOrganization","name": {{ site.title | jsonify }}}{% endcapture -%}

    {%- if doctor.image -%}
      {%- capture author_props -%}{{ author_props }}{% if author_props != "" %}, {% endif %}"image":{"@type":"ImageObject","url":{{ doctor.image | absolute_url | jsonify }}}{% endcapture -%}
    {%- endif -%}

    {%- if doctor.profile_url -%}
      {%- capture author_props -%}{{ author_props }}{% if author_props != "" %}, {% endif %}"url": {{ doctor.profile_url | absolute_url | jsonify }}{% endcapture -%}
    {%- endif -%}

    {%- comment -%}
    Build `description` from existing fields in the YAML (you already had degree, department, bio, experience)
    Keep the same concatenation but ensure safe output
    {%- endcomment -%}
    {%- assign degree_part = doctor.degree | join: ', ' | default: "" -%}
    {%- assign dept_part = doctor.department | default: "" -%}
    {%- assign bio_part = doctor.bio | default: "" -%}
    {%- assign exp_part = doctor.experience | default: "" -%}
    {%- assign desc_parts = degree_part -%}
    {%- if dept_part != "" -%}{% assign desc_parts = desc_parts | append: " — " | append: dept_part %}{% endif -%}
    {%- if bio_part != "" -%}{% assign desc_parts = desc_parts | append: " — " | append: bio_part %}{% endif -%}
    {%- if exp_part != "" -%}{% assign desc_parts = desc_parts | append: " — " | append: exp_part | append: " years experience" %}{% endif -%}

    {%- if desc_parts != "" -%}
      {%- capture author_props -%}{{ author_props }}{% if author_props != "" %}, {% endif %}"description": {{ desc_parts | strip_html | strip_newlines | truncate:800 | jsonify }}{% endcapture -%}
    {%- endif -%}

    {%- if doctor.education and doctor.education.size > 0 -%}
      {%- capture edu_array -%}{% for ed in doctor.education %}{% capture e %}{"@type":"EducationalOrganization","name":{{ (ed.degree | append: " — " | append: ed.institute) | jsonify }}}{% endcapture %}{% if forloop.first %}{{ e }}{% else %},{% endif %}{% endfor %}{% endcapture -%}
      {%- capture author_props -%}{{ author_props }}{% if author_props != "" %}, {% endif %}"alumniOf": [{{ edu_array }}]{% endcapture -%}
    {%- endif -%}

    {%- if doctor.services and doctor.services.size > 0 -%}
      {%- capture services_json -%}{{ doctor.services | jsonify }}{% endcapture -%}
      {%- capture author_props -%}{{ author_props }}{% if author_props != "" %}, {% endif %}"knowsAbout": {{ services_json }}{% endcapture -%}
    {%- endif -%}

    {%- if doctor.tags and doctor.tags.size > 0 -%}
      {%- capture author_props -%}{{ author_props }}{% if author_props != "" %}, {% endif %}"keywords": {{ doctor.tags | join: ', ' | jsonify }}{% endcapture -%}
    {%- endif -%}

    {%- if doctor.languages and doctor.languages.size > 0 -%}
      {%- capture author_props -%}{{ author_props }}{% if author_props != "" %}, {% endif %}"knowsLanguage": {{ doctor.languages | jsonify }}{% endcapture -%}
    {%- endif -%}

    {%- if author_props != "" -%},{% endif -%}
    {{ author_props }}
  },
  "publisher": {
    "@type": "Organization",
    "name": {{ site.title | jsonify }},
    "logo": {
      "@type": "ImageObject",
      "url": {{ site.logo | absolute_url | jsonify }}
    }
  }
}
</script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-7L1KNKJJ87"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-7L1KNKJJ87');
</script>

<link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
<link rel="stylesheet" href="{{ '/assets/css/post-layout.css' | relative_url }}">
<link rel="stylesheet" href="{{ '/assets/css/doctors.css' | relative_url }}">

